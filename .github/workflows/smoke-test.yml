name: Smoke Test (k3s)

on:
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Setup k3d
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: "recac-smoke"
          args: >-
            --agents 1
            --no-lb
            --volume /var/run/docker.sock:/var/run/docker.sock
            --k3s-arg "--disable=traefik@server:*"
            --k3s-arg "--disable=metrics-server@server:*"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Build Docker Image
        run: |
          make image-prod DEPLOY_IMAGE=recac:smoke

      - name: Load Image into k3d
        run: |
          k3d image import recac:smoke -c recac-smoke

      - name: Prepare Smoke Scenario
        run: |
          # Replace placeholder with current repo/branch
          # For PRs, we want the agent to clone the PR branch
          REPO_URL="https://github.com/${{ github.repository }}"
          sed -i "s|https://github.com/REPLACE_ME_REPO|$REPO_URL|g" tests/smoke-test/work_items.json

          # Create ConfigMap from work items
          kubectl create configmap smoke-test-work --from-file=work_items.json=tests/smoke-test/work_items.json

      - name: Deploy Helm (Smoke Config)
        run: |
          helm upgrade --install recac ./deploy/helm/recac \
            --set image.repository=recac \
            --set image.tag=smoke \
            --set image.pullPolicy=Never \
            --set config.imagePullPolicy=IfNotPresent \
            --set config.poller=file \
            --set config.work_file=/etc/recac-smoke/work_items.json \
            --set config.verbose=true \
            --set config.interval=10s \
            --set config.provider=gemini \
            --set config.model=gemini-1.5-flash \
            --set secrets.geminiApiKey="${{ secrets.GEMINI_API_KEY }}" \
            --set secrets.ghApiKey="${{ secrets.GH_API_KEY }}" \
            --set dockerSocket.enabled=false \
            --set extraVolumes[0].name=work-items \
            --set extraVolumes[0].configMap.name=smoke-test-work \
            --set extraVolumeMounts[0].name=work-items \
            --set extraVolumeMounts[0].mountPath=/etc/recac-smoke \
            --set extraVolumeMounts[0].readOnly=true

      - name: Wait for Orchestrator
        run: |
          echo "Waiting for orchestrator pod to be ready..."
          kubectl rollout status deployment/recac --timeout=120s || {
            echo "Orchestrator deployment failed"
            kubectl get pods
            kubectl describe pods -l app.kubernetes.io/name=recac
            exit 1
          }

      - name: Wait and Verify
        run: |
          echo "Waiting for orchestrator to spawn agent job..."
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if kubectl get jobs | grep -qi "recac-agent-smoke"; then
              echo "Agent job spawned!"
              break
            fi
            sleep 10
            elapsed=$((elapsed + 10))
          done
          kubectl get pods -A
          kubectl describe pods -l app=recac-agent || true

          if [ $elapsed -ge $timeout ]; then
            echo "Error: Orchestrator failed to spawn agent job within 5 minutes"
            kubectl logs -l app.kubernetes.io/name=recac
            exit 1
          fi

          echo "Waiting for agent job to complete..."
          JOB_NAME=$(kubectl get jobs -o name | grep "recac-agent-smoke" | head -n 1)
          kubectl wait --for=condition=complete "$JOB_NAME" --timeout=300s || {
            echo "Agent job failed or timed out"
            kubectl describe "$JOB_NAME" || true
            kubectl logs -l app=recac-agent --all-containers=true
            exit 1
          }

          echo "Smoke test passed!"
