name: RECAC CI

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Prepare Test Environment (Run only if Dockerfile changes)
  prepare-test-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image-tag.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Image Tag
        id: image-tag
        run: |
          # Hash test.Dockerfile to create a unique tag
          DOCKERFILE_HASH=${{ hashFiles('test.Dockerfile') }}
          IMAGE_TAG=test-${{ runner.os }}-${DOCKERFILE_HASH}
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          # Convert to lowercase
          IMAGE=$(echo $IMAGE | tr '[:upper:]' '[:lower:]')

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Check if Image Exists
        id: check-image
        continue-on-error: true
        run: |
          docker manifest inspect ${{ steps.image-tag.outputs.image }} > /dev/null

      - name: Set up Docker Buildx
        if: steps.check-image.outcome == 'failure'
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        if: steps.check-image.outcome == 'failure'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Go Version
        id: go-version
        run: |
          VERSION=$(grep "^go " go.mod | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push Test Image
        if: steps.check-image.outcome == 'failure'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: test.Dockerfile
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.version }}
          push: true
          tags: ${{ steps.image-tag.outputs.image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 2. Calculate Shards
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_shards: ${{ steps.set-matrix.outputs.total_shards }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Calculate Matrix
        id: set-matrix
        env:
          PACKAGES_PER_SHARD: 5
        run: |
          PACKAGE_COUNT=$(go list ./... | wc -l)
          # Calculate total shards (ceil(PACKAGE_COUNT / PACKAGES_PER_SHARD))
          TOTAL_SHARDS=$(( (PACKAGE_COUNT + PACKAGES_PER_SHARD - 1) / PACKAGES_PER_SHARD ))
          if [ "$TOTAL_SHARDS" -lt "1" ]; then TOTAL_SHARDS=1; fi
          MATRIX_JSON=$(jq -n -c "[range(1; $TOTAL_SHARDS + 1)]")
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "total_shards=$TOTAL_SHARDS" >> $GITHUB_OUTPUT

  # 3. Lint (Containerized)
  lint:
    needs: prepare-test-image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.prepare-test-image.outputs.image }}
      # options: --volume /var/run/docker.sock:/var/run/docker.sock # Lint generally doesn't need docker
    steps:
      - uses: actions/checkout@v4

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Configure Git for Private Modules
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "git@github.com:"
      - name: Lint
        run: |
          go mod download
          go vet ./...

  # 4. Test (Sharded - Runs on VM for Docker Support)
  test:
    needs: [setup-matrix]
    runs-on: ubuntu-latest
    # Note: We do NOT use 'container:' here because E2E tests utilize Docker volume mounts.
    # Mounting volumes from a containerized runner to a sibling container is problematic
    # (path mismatch between host and container). Running on the VM solves this.
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Configure Git for Private Modules
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "git@github.com:"

      - name: Build Agent Image for Tests
        run: |
          docker build -t recac-agent:latest -f internal/docker/agent.Dockerfile .

      - name: Test Shard ${{ matrix.shard }}
        run: |
          # Use the script directly
          chmod +x scripts/test_sharded.sh
          ./scripts/test_sharded.sh ${{ matrix.shard }} ${{ needs.setup-matrix.outputs.total_shards }}

  # 5. Build Binary Verification (Containerized)
  build:
    needs: prepare-test-image
    runs-on: ubuntu-latest
    container: ${{ needs.prepare-test-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Configure Git for Private Modules
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "git@github.com:"

      - name: Build Binaries
        run: |
          go mod download
          go build -buildvcs=false -o recac ./cmd/recac
          go build -buildvcs=false -o agent-bridge ./cmd/agent-bridge

  # 6. Deploy Production Image (Run on Main)
  deploy:
    needs: [lint, test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Extract Go Version
        id: go-version
        run: |
          VERSION=$(grep "^go " go.mod | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push Production Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.version }}
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=prod
          cache-to: type=gha,mode=max,scope=prod
