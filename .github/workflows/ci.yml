name: RECAC CI

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main"]

jobs:
  # 1. Build Docker Image (Build Once)
  prepare-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Export Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build.Dockerfile
          load: true # Load into local docker daemon to export
          tags: recac-build:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/recac-build.tar

      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: recac-image
          path: /tmp/recac-build.tar
          retention-days: 1

  # 2. Calculate Shards (Lightweight)
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_shards: ${{ steps.set-matrix.outputs.total_shards }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Calculate Matrix
        id: set-matrix
        env:
          PACKAGES_PER_SHARD: 5
        run: |
          PACKAGE_COUNT=$(go list ./... | wc -l)
          echo "Found $PACKAGE_COUNT packages"

          # Calculate total shards (ceil(PACKAGE_COUNT / PACKAGES_PER_SHARD))
          TOTAL_SHARDS=$(( (PACKAGE_COUNT + PACKAGES_PER_SHARD - 1) / PACKAGES_PER_SHARD ))
          if [ "$TOTAL_SHARDS" -lt "1" ]; then TOTAL_SHARDS=1; fi
          echo "Total shards: $TOTAL_SHARDS"

          # Generate JSON array [1, 2, ..., TOTAL_SHARDS]
          MATRIX_JSON=$(jq -n -c "[range(1; $TOTAL_SHARDS + 1)]")
          echo "Matrix: $MATRIX_JSON"

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "total_shards=$TOTAL_SHARDS" >> $GITHUB_OUTPUT

  # 3. Lint (Run Many - Uses Image)
  lint:
    needs: prepare-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: recac-image
          path: /tmp

      - name: Load Image
        run: docker load --input /tmp/recac-build.tar

      - name: Lint
        run: make lint

  # 4. Test Shards (Run Many - Uses Image)
  test:
    needs: [prepare-image, setup-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: recac-image
          path: /tmp

      - name: Load Image
        run: docker load --input /tmp/recac-build.tar

      - name: Test Shard ${{ matrix.shard }}
        run: |
          make test-sharded SHARD=${{ matrix.shard }} TOTAL_SHARDS=${{ needs.setup-matrix.outputs.total_shards }}

  # 5. Build Binary (Run Many - Uses Image)
  build:
    needs: prepare-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: recac-image
          path: /tmp

      - name: Load Image
        run: docker load --input /tmp/recac-build.tar

      - name: Build Binaries
        run: |
          make build
          make bridge

      - name: Check Artifact
        run: |
          ls -lh recac
          ls -lh agent-bridge
