name: RECAC CI

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build.Dockerfile
          load: true
          tags: recac-build:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Lint
        run: make lint

  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_shards: ${{ steps.set-matrix.outputs.total_shards }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Calculate Matrix
        id: set-matrix
        env:
          PACKAGES_PER_SHARD: 5
        run: |
          PACKAGE_COUNT=$(go list ./... | wc -l)
          echo "Found $PACKAGE_COUNT packages"

          # Calculate total shards (ceil(PACKAGE_COUNT / PACKAGES_PER_SHARD))
          TOTAL_SHARDS=$(( (PACKAGE_COUNT + PACKAGES_PER_SHARD - 1) / PACKAGES_PER_SHARD ))
          if [ "$TOTAL_SHARDS" -lt "1" ]; then TOTAL_SHARDS=1; fi
          echo "Total shards: $TOTAL_SHARDS"

          # Generate JSON array [1, 2, ..., TOTAL_SHARDS]
          MATRIX_JSON=$(jq -n -c "[range(1; $TOTAL_SHARDS + 1)]")
          echo "Matrix: $MATRIX_JSON"

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "total_shards=$TOTAL_SHARDS" >> $GITHUB_OUTPUT

  test:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build.Dockerfile
          load: true
          tags: recac-build:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Shard ${{ matrix.shard }}
        run: |
          make test-sharded SHARD=${{ matrix.shard }} TOTAL_SHARDS=${{ needs.setup-matrix.outputs.total_shards }}

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build.Dockerfile
          load: true
          tags: recac-build:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Binaries
        run: |
          make build
          make bridge

      - name: Check Artifact
        run: |
          ls -lh recac
          ls -lh agent-bridge
