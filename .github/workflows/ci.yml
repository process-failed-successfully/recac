name: RECAC CI

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Prepare Test Environment (Run only if Dockerfile changes)
  prepare-test-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image-tag.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Image Tag
        id: image-tag
        run: |
          # Hash test.Dockerfile to create a unique tag
          DOCKERFILE_HASH=${{ hashFiles('test.Dockerfile') }}
          IMAGE_TAG=test-${{ runner.os }}-${DOCKERFILE_HASH}
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          # Convert to lowercase
          IMAGE=$(echo $IMAGE | tr '[:upper:]' '[:lower:]')

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Check if Image Exists
        id: check-image
        continue-on-error: true
        run: |
          docker manifest inspect ${{ steps.image-tag.outputs.image }} > /dev/null

      - name: Set up Docker Buildx
        if: steps.check-image.outcome == 'failure'
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        if: steps.check-image.outcome == 'failure'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Go Version
        id: go-version
        run: |
          VERSION=$(grep "^go " go.mod | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push Test Image
        if: steps.check-image.outcome == 'failure'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: test.Dockerfile
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.version }}
          push: true
          tags: ${{ steps.image-tag.outputs.image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 2. Calculate Shards
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_shards: ${{ steps.set-matrix.outputs.total_shards }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Calculate Matrix
        id: set-matrix
        env:
          PACKAGES_PER_SHARD: 5
        run: |
          PACKAGE_COUNT=$(go list ./... | wc -l)
          # Calculate total shards (ceil(PACKAGE_COUNT / PACKAGES_PER_SHARD))
          TOTAL_SHARDS=$(( (PACKAGE_COUNT + PACKAGES_PER_SHARD - 1) / PACKAGES_PER_SHARD ))
          if [ "$TOTAL_SHARDS" -lt "1" ]; then TOTAL_SHARDS=1; fi
          MATRIX_JSON=$(jq -n -c "[range(1; $TOTAL_SHARDS + 1)]")
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "total_shards=$TOTAL_SHARDS" >> $GITHUB_OUTPUT

  # 3. Lint (Containerized)
  lint:
    needs: prepare-test-image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.prepare-test-image.outputs.image }}
      # options: --volume /var/run/docker.sock:/var/run/docker.sock # Lint generally doesn't need docker
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git for private modules
        env:
          GITHUB_API_KEY: ${{ secrets.GH_API_KEY }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_API_KEY}@github.com/".insteadOf "https://github.com/"

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Lint
        run: |
          go mod download
          go vet ./...

  # 4. Test (Sharded - Runs on VM for Docker Support)
  test:
    needs: [setup-matrix]
    runs-on: ubuntu-latest
    # Note: We do NOT use 'container:' here because E2E tests utilize Docker volume mounts.
    # Mounting volumes from a containerized runner to a sibling container is problematic
    # (path mismatch between host and container). Running on the VM solves this.
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git for private modules
        env:
          GITHUB_API_KEY: ${{ secrets.GH_API_KEY }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_API_KEY}@github.com/".insteadOf "https://github.com/"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build Agent Image for Tests
        run: |
          docker build -t recac-agent:latest -f internal/docker/agent.Dockerfile .

      - name: Test Shard ${{ matrix.shard }}
        run: |
          # Use the script directly
          chmod +x scripts/test_sharded.sh
          ./scripts/test_sharded.sh ${{ matrix.shard }} ${{ needs.setup-matrix.outputs.total_shards }}

  # 5. Build Binary Verification (Containerized)
  build:
    needs: prepare-test-image
    runs-on: ubuntu-latest
    container: ${{ needs.prepare-test-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git for private modules
        env:
          GITHUB_API_KEY: ${{ secrets.GH_API_KEY }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_API_KEY}@github.com/".insteadOf "https://github.com/"

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build Binaries
        run: |
          go build -buildvcs=false -o recac ./cmd/recac
          go build -buildvcs=false -o agent-bridge ./cmd/agent-bridge

  # 6. Deploy Production Image (Run on Main)
  deploy:
    needs: [lint, test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Extract Go Version
        id: go-version
        run: |
          VERSION=$(grep "^go " go.mod | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push Production Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          build-args: |
            GO_VERSION=${{ steps.go-version.outputs.version }}
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=prod
          cache-to: type=gha,mode=max,scope=prod

  # 7. Smoke Test (k3s) - Consolidated from smoke-test.yml
  smoke-test:
    runs-on: ubuntu-latest
    # Run in parallel with others, but fail fast if early checks fail could be added.
    # For now, running in parallel is fastest.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Configure Git for private modules
        env:
          GITHUB_API_KEY: ${{ secrets.GH_API_KEY }}
        run: |
          git config --global url."https://x-access-token:${GITHUB_API_KEY}@github.com/".insteadOf "https://github.com/"

      - name: Setup k3d
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: "recac-smoke"
          args: >-
            --agents 1
            --no-lb
            --no-lb
            --k3s-arg "--disable=traefik@server:*"
            --k3s-arg "--disable=metrics-server@server:*"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Build Docker Image
        run: |
          make image-prod DEPLOY_IMAGE=recac:smoke

      - name: Load Image into k3d
        run: |
          k3d image import recac:smoke -c recac-smoke

      - name: Run E2E Test
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_API_KEY: ${{ secrets.GH_API_KEY }}
          GITHUB_EMAIL: ${{ secrets.GH_EMAIL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          RETRIES=3
          for i in $(seq 0 $RETRIES); do
            echo "Attempt $((i+1)) of $((RETRIES+1))"
            if go run e2e/runner/main.go \
              -scenario prime-python \
              -provider openrouter \
              -model "mistralai/devstral-2512:free" \
              -image recac:smoke \
              -repo-url "https://github.com/process-failed-successfully/recac-jira-e2e" \
              -pull-policy IfNotPresent \
              -skip-build; then
              echo "Test passed!"
              exit 0
            fi
            echo "Attempt $((i+1)) failed."
            if [ $i -lt $RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done
          echo "All attempts failed."
          exit 1

  # 8. Auto-Merge PR (Consolidated from mergy.yml)
  auto-merge:
    name: ðŸ¦¾ Auto-Merge PR
    needs: [lint, test, build, smoke-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: "ðŸš¢ Merge PR"
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              console.log("No pull request found in context.");
              return;
            }
            const prNumber = pr.number;

            try {
              console.log(`All required workflows passed (ensured by 'needs'). Processing PR #${prNumber}...`);

              // 1. Get PR details to check if it's a draft and get node_id
              const { data: prDetails } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              // 2. If it's a draft, promote it
              if (prDetails.draft) {
                console.log(`PR #${prNumber} is a draft. Promoting...`);
                const mutation = `
                  mutation($pullRequestId: ID!) {
                    markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                      pullRequest { id isDraft }
                    }
                  }
                `;
                await github.graphql(mutation, { pullRequestId: prDetails.node_id });
                console.log(`Successfully promoted PR #${prNumber}`);
              }

              // 3. Approve the PR (Required by branch protection)
              // Note: You cannot approve your own PR. If the token belongs to the PR author, this might fail.
              // Assuming GITHUB_TOKEN or a bot token is used.
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  event: 'APPROVE'
                });
                console.log(`Successfully approved PR #${prNumber}`);
              } catch (approveError) {
                console.log(`Approval step skipped or failed: ${approveError.message}. Continuing to merge attempt...`);
              }

              // 4. Merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log(`Successfully merged PR #${prNumber}`);
            } catch (error) {
              console.error(`Failed to process PR #${prNumber}:`, error.message);
              core.setFailed(`Auto-merge failed: ${error.message}`);
            }
