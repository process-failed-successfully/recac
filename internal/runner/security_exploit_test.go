package runner

import (
	"context"
	"log/slog"
	"os"
	"path/filepath"
	"recac/internal/notify"
	"recac/internal/security"
	"testing"
)

func TestSecurity_LocalExecution_PathTraversal(t *testing.T) {
	// Setup temporary environment
	tmpDir, err := os.MkdirTemp("", "recac-security-test")
	if err != nil {
		t.Fatal(err)
	}
	defer os.RemoveAll(tmpDir)

	// Structure:
	// tmpDir/
	//   workspace/
	//   sensitive.txt

	workspace := filepath.Join(tmpDir, "workspace")
	if err := os.Mkdir(workspace, 0755); err != nil {
		t.Fatal(err)
	}

	sensitiveFile := filepath.Join(tmpDir, "sensitive.txt")
	if err := os.WriteFile(sensitiveFile, []byte("SECRET"), 0644); err != nil {
		t.Fatal(err)
	}

	// Initialize session with Local Agent mode AND Security Scanner
	s := &Session{
		UseLocalAgent: true,
		Workspace:     workspace,
		Project:       "test-project",
		Notifier:      notify.NewManager(func(string, ...interface{}) {}),
		Logger:        slog.Default(),
		Scanner:       security.NewRegexScanner(),
	}

	// Attack payload: Try to delete the sensitive file outside workspace
	// "rm -rf ../sensitive.txt"
	payload := "I will delete the secret.\n```bash\nrm -rf ../sensitive.txt\n```"

	// Execute
	output, err := s.ProcessResponse(context.Background(), payload)

	// Check if file still exists
	if _, err := os.Stat(sensitiveFile); os.IsNotExist(err) {
		t.Fatalf("CRITICAL SECURITY FAILURE: Path traversal attack succeeded! 'sensitive.txt' was deleted.\nOutput: %s\nError: %v", output, err)
	} else if err != nil {
		t.Fatalf("Error checking file: %v", err)
	} else {
		// File exists, which means the attack was blocked!
		t.Logf("SUCCESS: File preserved. Output: %s", output)
	}
}
